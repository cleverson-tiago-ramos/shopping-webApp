name: CI/CD Monorepo

on:
  push:
    tags:
      - "v*" # Ex: v1.0.0, v2.3.1

jobs:
  changes:
    name: ğŸ•µï¸ Detectar alteraÃ§Ãµes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      admin: ${{ steps.filter.outputs.admin }}
      site: ${{ steps.filter.outputs.site }}

    steps:
      - name: â¬‡ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ“‚ Verificar arquivos alterados
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'config/**'
            admin:
              - 'apps/admin/**'
              - 'config/**'
            site:
              - 'apps/site/**'
              - 'config/**'

  build-api:
    name: ğŸ“¡ Build & Deploy API
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        working-directory: apps/api
        run: npm ci

      - name: ğŸ—ï¸ Build da API
        working-directory: apps/api
        run: npm run build

      - name: ğŸš€ Simular Deploy
        run: echo "âœ… Deploy da API com a tag ${{ github.ref_name }} concluÃ­do!"

  build-admin:
    name: ğŸ› ï¸ Build & Deploy Admin
    needs: changes
    if: needs.changes.outputs.admin == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        working-directory: apps/admin
        run: npm ci

      - name: ğŸ—ï¸ Build do Admin
        working-directory: apps/admin
        run: npm run build

      - name: ğŸš€ Simular Deploy
        run: echo "âœ… Deploy do Admin com a tag ${{ github.ref_name }} concluÃ­do!"

  build-site:
    name: ğŸŒ Build & Deploy Site
    needs: changes
    if: needs.changes.outputs.site == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        working-directory: apps/site
        run: npm ci

      - name: ğŸ—ï¸ Build do Site
        working-directory: apps/site
        run: npm run build

      - name: ğŸš€ Simular Deploy
        run: echo "âœ… Deploy do Site com a tag ${{ github.ref_name }} concluÃ­do!"
