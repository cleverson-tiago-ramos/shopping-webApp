name: CI/CD Monorepo

on:
  push:
    tags:
      - "v*" # Ex: v1.0.0, v2.3.1

jobs:
  changes:
    name: 🕵️ Detectar alterações
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      admin: ${{ steps.filter.outputs.admin }}
      site: ${{ steps.filter.outputs.site }}

    steps:
      - name: ⬇️ Checkout do código
        uses: actions/checkout@v3

      - name: 📂 Verificar arquivos alterados
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'config/**'
            admin:
              - 'apps/admin/**'
              - 'config/**'
            site:
              - 'apps/site/**'
              - 'config/**'

  build-api:
    name: 📡 Build & Deploy API
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ⚙️ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Instalar dependências
        working-directory: apps/api
        run: npm ci

      - name: 🏗️ Build da API
        working-directory: apps/api
        run: npm run build

      - name: 🚀 Simular Deploy
        run: echo "✅ Deploy da API com a tag ${{ github.ref_name }} concluído!"

  build-admin:
    name: 🛠️ Build & Deploy Admin
    needs: changes
    if: needs.changes.outputs.admin == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ⚙️ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Instalar dependências
        working-directory: apps/admin
        run: npm ci

      - name: 🏗️ Build do Admin
        working-directory: apps/admin
        run: npm run build

      - name: 🚀 Simular Deploy
        run: echo "✅ Deploy do Admin com a tag ${{ github.ref_name }} concluído!"

  build-site:
    name: 🌐 Build & Deploy Site
    needs: changes
    if: needs.changes.outputs.site == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ⚙️ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Instalar dependências
        working-directory: apps/site
        run: npm ci

      - name: 🏗️ Build do Site
        working-directory: apps/site
        run: npm run build

      - name: 🚀 Simular Deploy
        run: echo "✅ Deploy do Site com a tag ${{ github.ref_name }} concluído!"
