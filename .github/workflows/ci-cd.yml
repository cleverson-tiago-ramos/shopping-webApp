name: CI/CD Monorepo

on:
  push:
    tags:
      - "api-v*"
      - "admin-v*"
      - "site-v*"

jobs:
  build-api:
    name: 📡 API - NestJS
    if: startsWith(github.ref, 'refs/tags/api-v')
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout do código
        uses: actions/checkout@v3

      - name: ⚙️ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Instala dependências
        working-directory: apps/api
        run: npm ci

      - name: 🏗️ Build da API
        working-directory: apps/api
        run: npm run build

      - name: 📤 Deploy da API (simulado)
        run: echo "✅ Deploy da API via tag concluído!"

  build-admin:
    name: 🛠️ Admin - Painel Next.js
    if: startsWith(github.ref, 'refs/tags/admin-v')
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout do código
        uses: actions/checkout@v3

      - name: ⚙️ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Instala dependências
        working-directory: apps/admin
        run: npm ci

      - name: 🏗️ Build do Admin
        working-directory: apps/admin
        run: npm run build

      - name: 📤 Deploy do Admin via tag
        run: echo "✅ Deploy do Painel via tag concluído!"

  build-site:
    name: 🌐 Site - Next.js
    if: startsWith(github.ref, 'refs/tags/site-v')
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout do código
        uses: actions/checkout@v3

      - name: ⚙️ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Instala dependências
        working-directory: apps/site
        run: npm ci

      - name: 🏗️ Build do Site
        working-directory: apps/site
        run: npm run build

      - name: 📤 Deploy do Site via tag
        run: echo "✅ Deploy do Site via tag concluído!"
